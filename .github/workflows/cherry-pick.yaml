name: Cherry-pick to release branches

on:
  pull_request:
    types: [closed]
    branches:
      - master # Adjust this to your default branch if different


jobs:
  setup:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.get-branches.outputs.branches }}
    
    steps:
      - name: Get release branches
        id: get-branches
        run: |
          # Get the RELEASE_BRANCHES variable and convert to JSON array
          BRANCHES="${{ vars.RELEASE_BRANCHES }}"
          
          if [ -z "$BRANCHES" ]; then
            echo "No release branches configured in RELEASE_BRANCHES variable"
            echo "branches=[]" >> $GITHUB_OUTPUT
          else
            # Convert space-separated list to JSON array (compact format)
            JSON_ARRAY=$(echo "$BRANCHES" | tr ' ' '\n' | jq -R . | jq -s . | jq -c .)
            echo "branches=${JSON_ARRAY}" >> $GITHUB_OUTPUT
            echo "Will cherry-pick to branches: ${BRANCHES}"
          fi

  cherry-pick:
    needs: setup
    if: needs.setup.outputs.branches != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue with other branches even if one fails
      matrix:
        branch: ${{ fromJson(needs.setup.outputs.branches) }}
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for cherry-picking
          
      - name: Show GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
        
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          
      - name: Cherry-pick to ${{ matrix.branch }}
        id: create-branch
        run: |
          TARGET_BRANCH="${{ matrix.branch }}"
          
          # Fetch the target branch
          git fetch origin ${TARGET_BRANCH}:${TARGET_BRANCH}
          
          # Create a unique branch name for the cherry-pick
          BRANCH_NAME="cherry-pick-pr-${{ github.event.pull_request.number }}-to-${TARGET_BRANCH}"
          MERGE_COMMIT="${{ github.sha }}"

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          
          # Create and checkout the new branch from target branch
          git checkout -b ${BRANCH_NAME} ${TARGET_BRANCH}
          
          # Attempt cherry-pick and capture success/failure
          if git cherry-pick ${MERGE_COMMIT}; then
            echo "Cherry-pick successful for ${TARGET_BRANCH}"
            echo "CHERRY_PICK_SUCCESSFUL=true" >> $GITHUB_OUTPUT
            
            # Push the branch if cherry-pick was successful
            git push origin ${BRANCH_NAME}
          else
            echo "Cherry-pick failed for ${TARGET_BRANCH} - conflicts detected"
            echo "CHERRY_PICK_SUCCESSFUL=false" >> $GITHUB_OUTPUT
            
            # Show the conflicted files for debugging
            echo "Conflicted files:"
            git status --short
            
            # Abort the cherry-pick to clean up
            git cherry-pick --abort || true
            
            # Exit with error code to mark the step as failed
            exit 1
          fi
          
      - name: Create PR
        if: steps.create-branch.outputs.CHERRY_PICK_SUCCESSFUL == 'true'
        env:
          GH_TOKEN: ${{ secrets.CPP_GITHUB_RW_TOKEN }}
        run: |
          # Use the original PR's title and body
          ORIGINAL_TITLE="${{ github.event.pull_request.title }}"
          ORIGINAL_BODY="${{ github.event.pull_request.body }}"
          TARGET_BRANCH="${{ steps.create-branch.outputs.target_branch }}"
          
          # Create the pull request with the same title and body as the original
          gh pr create \
            --base ${TARGET_BRANCH} \
            --head ${{ steps.create-branch.outputs.branch_name }} \
            --title "[Cherry-pick to ${TARGET_BRANCH}] ${ORIGINAL_TITLE}" \
            --body "${ORIGINAL_BODY}
          
          ---
          Cherry-picked from #${{ github.event.pull_request.number }}"